{{- $section := .Section -}}
{{- $formats := .Page.Params.Format -}}
{{- $destination := printf "assets/scripts/" -}}

{{- if .IsHome -}}
    {{- $destination = printf "assets/scripts/home" -}}
{{- end -}}

{{- if .IsSection -}}
    {{- $destination = printf "assets/scripts/%s" .Section -}}
{{ end }}

{{- if .IsPage -}}
    {{- if .Section -}}
        {{- $destination = printf "assets/scripts/%s" .Section -}}
    {{- else -}}
        {{- $destination = printf "assets/scripts/page" -}}
    {{- end -}}
{{- end -}}


{{- $master_jsm := resources.Get "scripts/based/jsm/head.js" -}}
{{- $themes_jsm := resources.Get "scripts/based/jsm/main.js" -}}
{{- $module_jsm := resources.Get "scripts/based/jsm/over.js" -}}
{{- $format_jsm := resources.Get "scripts/based/jsm/over.js" -}}
{{- $extras_jsm := resources.Get "scripts/based/jsm/over.js" -}}


{{- if .Section -}}

    {{- $get_module := ""  -}}

    {{- if and ( .Page.Params.Model ) ( .Page.Params.Paged ) ( .IsPage ) -}}

        {{- $get_module = printf "scripts/%s/%s/%s" .Section .Page.Params.Model .Page.Params.Paged -}}

    {{- else if and ( .Page.Params.Model ) ( .Page.Params.Paged ) -}}

        {{- $get_module = printf "scripts/%s/%s/%s" .Section .Page.Params.Model .Page.Params.Paged -}}

    {{- else if and ( .Page.Params.Model ) ( .IsPage ) -}}

        {{- $get_module = printf "scripts/%s/%s/page" .Section .Page.Params.Model -}}

    {{- else if .Page.Params.Model -}}

        {{- $get_module = printf "scripts/%s/%s/item" .Section .Page.Params.Model -}}

    {{ else if .Page.Params.Paged }}

        {{- $get_module = printf "scripts/%s/default/%s" .Section .Page.Params.Paged -}}

    {{- else if .IsPage -}}

        {{- $get_module = printf "scripts/%s/default/page" .Section -}}

    {{- else -}}

        {{- $get_module = printf "scripts/%s/default/item" .Section -}}

    {{- end -}}

    {{- $try_module := printf "%s/jsm/head.js" $get_module -}}
    {{- with resources.Get $try_module -}}{{- $module_jsm = resources.Get . -}}{{- end -}}
    
{{- end -}}


{{- if .Page.Params.Format.Kind -}}

    {{- $skins := printf "format/%s/model/%s.html" .Page.Params.Format.Kind .Page.Params.Format.Skin -}}
    {{- $modul := printf "format/%s/model/%s.html" .Page.Params.Format.Kind .Section -}}
    {{- $forma := printf "format/%s/model/default.html" .Page.Params.Format.Kind -}}
    {{- $gform := "" -}}
   
    {{- if templates.Exists ( printf "partials/%s" $skins ) -}}

        {{- $gform = printf "scripts/formats/%s/%s" .Page.Params.Format.Kind .Page.Params.Format.Skin -}}

    {{- else if templates.Exists ( printf "partials/%s" $modul ) -}}

        {{- $gform = printf "scripts/formats/%s/%s" .Page.Params.Format.Kind .Section -}}
    
    {{- else if templates.Exists ( printf "partials/%s" $forma ) -}}

        {{- $gform = printf "scripts/formats/%s/default" .Page.Params.Format.Kind -}}

    {{- else -}}

        {{- $gform = printf "scripts/formats/default/default" -}}

    {{- end -}}

    {{- $try_format := printf "%s/jsm/head.js" $gform -}}
    {{- with resources.Get $try_format -}}{{- $format_jsm = resources.Get . -}}{{- end -}}

{{- end -}}


{{- with .Site.Params.Themes -}}
    {{- $theme_path := printf "scripts/themes/%s/jsm/head.js" . -}}
    {{- $themes_jsm = resources.Get $theme_path -}}
{{- end -}}

{{- with resources.Get "scripts/module.js" -}}
    {{- $extras_jsm = resources.Get . -}}
{{- end -}}


{{- with and ( resources.Get $master_jsm ) ( resources.Get $format_jsm ) ( resources.Get $module_jsm ) ( resources.Get $themes_jsm ) ( resources.Get $extras_jsm ) -}}

    {{- $dest := "" -}}
    {{- if $formats -}}
        {{- $dest = printf "%s/%s-module.js" $destination $formats -}}
    {{- else -}}
        {{- $dest = printf "%s/head-module.js" $destination -}}
    {{- end -}}

    {{- $opts := dict "minify" (not hugo.IsDevelopment) "sourceMap" (cond hugo.IsDevelopment "external" "") "targetPath" $dest -}}
    {{- $path := slice $master_jsm $format_jsm $module_jsm $themes_jsm $extras_jsm | resources.Concat $dest -}}

    {{- with $path | js.Build $opts -}}
        <script id="head-module" type="module">{{- .Content | safeJS -}}</script>
    {{- end -}}

{{- end -}}